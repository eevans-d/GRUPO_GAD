# ðŸ“Š DIAGRAMAS & FLOWCHARTS - Despliegue Fly.io

## 1. ARQUITECTURA GENERAL (DespuÃ©s del Despliegue)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CLIENTE                                     â”‚
â”‚                      (Navegador/CLI)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ HTTP/HTTPS
                             â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Fly.io Load Balancer (Miami)           â”‚
        â”‚   - TLS Termination                      â”‚
        â”‚   - Port 80 â†’ redirect HTTPS             â”‚
        â”‚   - Port 443 â†’ 8080                      â”‚
        â”‚   - Health checks /health (15s)          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ :8080 internal
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   FastAPI Container (grupo-gad)          â”‚
        â”‚   â”œâ”€ Uvicorn 1 worker                    â”‚
        â”‚   â”œâ”€ Python 3.12                         â”‚
        â”‚   â”œâ”€ Port: 8080                          â”‚
        â”‚   â””â”€ Lifespan:                           â”‚
        â”‚      â”œâ”€ DB Pool (10 connections)         â”‚
        â”‚      â”œâ”€ WebSocket Manager                â”‚
        â”‚      â””â”€ Cache Service (Redis)            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                       â”‚                  â”‚
        â–¼                                       â–¼                  â–¼
   PostgreSQL                              Redis/Upstash      Metrics
   (grupo-gad-db)                          (Cache Layer)      (Prometheus)
   â”œâ”€ Database: gcp_db
   â”œâ”€ User: gcp_user
   â””â”€ Connection Pool
```

---

## 2. FASES DE DESPLIEGUE (Timeline)

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    DEPLOYMENT PHASES TIMELINE                        â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£

FASE 1: BUILD (ConstrucciÃ³n de Imagen)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 0:00  $ flyctl deploy --app grupo-gad                              â”‚
â”‚       â””â”€ CLI contact Fly.io API                                    â”‚
â”‚                                                                     â”‚
â”‚ 0:05  Docker Build Stage 1: Builder                                â”‚
â”‚       â”œâ”€ FROM python:3.12-slim                                     â”‚
â”‚       â”œâ”€ apt-get install gcc, libpq-dev, python3-dev  âœ… FIXED    â”‚
â”‚       â”œâ”€ pip install -r requirements.txt (45s)                     â”‚
â”‚       â””â”€ (asyncpg compiles successfully now) âœ…                    â”‚
â”‚                                                                     â”‚
â”‚ 0:50  Docker Build Stage 2: Runtime                                â”‚
â”‚       â”œâ”€ FROM python:3.12-slim                                     â”‚
â”‚       â”œâ”€ apt-get install curl, libpq5  âœ… FIXED                    â”‚
â”‚       â”œâ”€ COPY /install from builder                                â”‚
â”‚       â”œâ”€ COPY alembic/, config/, src/, templates/                 â”‚
â”‚       â””â”€ Image ready: ~185MB                                       â”‚
â”‚                                                                     â”‚
â”‚ 1:00  âœ… BUILD COMPLETE                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

FASE 2: PUSH (EnvÃ­o a Registry)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1:00  Push image to registry.fly.io                                â”‚
â”‚       â”œâ”€ Upload 185MB image                                        â”‚
â”‚       â”œâ”€ Register in Fly.io artifact store                         â”‚
â”‚       â””â”€ Retorna: registry.fly.io/grupo-gad:build.abc123           â”‚
â”‚                                                                     â”‚
â”‚ 1:15  âœ… IMAGE PUSHED                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

FASE 3: RELEASE (Migraciones pre-deployment)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1:20  Spin up RELEASE MACHINE                                      â”‚
â”‚       â”œâ”€ Crear mÃ¡quina TEMPORAL para release command               â”‚
â”‚       â”œâ”€ Inyectar secrets (DATABASE_URL, etc)                      â”‚
â”‚       â”œâ”€ Mount Dockerfile CMD â†’ release_command                    â”‚
â”‚       â””â”€ Execute: alembic upgrade head                             â”‚
â”‚                                                                     â”‚
â”‚ 1:25  $ alembic upgrade head                                       â”‚
â”‚       â”œâ”€ Read alembic.ini                                          â”‚
â”‚       â”œâ”€ Import src.api.models                                     â”‚
â”‚       â”œâ”€ Connect to DATABASE_URL (PostgreSQL)                      â”‚
â”‚       â”œâ”€ Check alembic_version table                               â”‚
â”‚       â”œâ”€ Run pending migrations (if any)                           â”‚
â”‚       â””â”€ Return: "head is now at XYZ"                              â”‚
â”‚                                                                     â”‚
â”‚ 1:30  âœ… MIGRATIONS COMPLETE                                       â”‚
â”‚       Kill release machine (no longer needed)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

FASE 4: STARTUP (Arranque de AplicaciÃ³n)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1:35  Spin up PRODUCTION MACHINE                                   â”‚
â”‚       â”œâ”€ new machine in mia region                                 â”‚
â”‚       â”œâ”€ Inyectar secrets (DATABASE_URL, REDIS_URL, etc)           â”‚
â”‚       â””â”€ Mount image from registry                                 â”‚
â”‚                                                                     â”‚
â”‚ 1:40  $ CMD: uvicorn src.api.main:app ...                         â”‚
â”‚       â”œâ”€ 0s Import FastAPI, SQLAlchemy modules                     â”‚
â”‚       â”œâ”€ 1s Load settings (read env vars)                          â”‚
â”‚       â”œâ”€ 2s init_db(database_url)                                  â”‚
â”‚       â”‚   â””â”€ Create async_engine connection pool                   â”‚
â”‚       â”œâ”€ 3s await websocket_event_emitter.start()                 â”‚
â”‚       â”œâ”€ 4s initialize_websocket_integrator()                      â”‚
â”‚       â”œâ”€ 5s initialize_metrics() if enabled                        â”‚
â”‚       â””â”€ READY TO SERVE (yield en lifespan)                        â”‚
â”‚                                                                     â”‚
â”‚ 1:45  âœ… APPLICATION STARTUP COMPLETE                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

FASE 5: HEALTH CHECKS (Validar disponibilidad)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1:45  Grace period: 30s (waiting for app stability)                â”‚
â”‚       â”œâ”€ Health check endpoint /health is disabled during grace   â”‚
â”‚       â””â”€ (prevents false failures during startup)                 â”‚
â”‚                                                                     â”‚
â”‚ 2:15  First health check attempt #1                                â”‚
â”‚       â”œâ”€ GET /health                                               â”‚
â”‚       â”œâ”€ Timeout: 10s                                              â”‚
â”‚       â””â”€ Result: 200 OK âœ…                                         â”‚
â”‚                                                                     â”‚
â”‚ 2:30  Health check #2: 200 OK âœ…                                   â”‚
â”‚ 2:45  Health check #3: 200 OK âœ…                                   â”‚
â”‚                                                                     â”‚
â”‚ 2:45  âœ… 3/3 CHECKS PASSED - Machine is HEALTHY                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

FASE 6: ROLLING DEPLOYMENT (Cambio de trÃ¡fico)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2:50  Load Balancer redirects NEW requests to new machine          â”‚
â”‚       â”œâ”€ In-flight requests continue to OLD machine                â”‚
â”‚       â”œâ”€ NEW requests â†’ NEW machine (grupo-gad v2)                 â”‚
â”‚       â””â”€ Gradual traffic shift (rolling strategy)                  â”‚
â”‚                                                                     â”‚
â”‚ 3:00  All traffic on NEW machine                                   â”‚
â”‚       â”œâ”€ OLD machine graceful shutdown                             â”‚
â”‚       â”œâ”€ Send SIGINT to uvicorn                                    â”‚
â”‚       â”œâ”€ Close DB connections properly                             â”‚
â”‚       â”œâ”€ Shutdown WebSocket connections                            â”‚
â”‚       â””â”€ OLD machine killed after timeout                          â”‚
â”‚                                                                     â”‚
â”‚ 3:05  âœ… DEPLOYMENT COMPLETE                                       â”‚
â”‚       â”œâ”€ New version LIVE: grupo-gad.fly.dev                       â”‚
â”‚       â”œâ”€ Traffic flowing normally                                  â”‚
â”‚       â””â”€ Old machine removed from cluster                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

TOTAL TIME: ~3 minutes (180 seconds)

â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## 3. BUILD PHASE: MULTI-STAGE DEEP DIVE

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         DOCKERFILE BUILD SEQUENCE (FIXED v2)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

STAGE 1: BUILDER (CompilaciÃ³n - Final: 450 MB)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FROM python:3.12-slim AS builder                        â”‚
â”‚ â”œâ”€ Size: 140 MB                                         â”‚
â”‚ â”œâ”€ OS: Debian trixie (slim)                             â”‚
â”‚ â””â”€ Python: 3.12.3                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ENV PYTHONDONTWRITEBYTECODE=1                           â”‚
â”‚ ENV PYTHONUNBUFFERED=1                                  â”‚
â”‚ ENV PIP_NO_CACHE_DIR=1                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RUN apt-get update && apt-get install -y               â”‚
â”‚   gcc g++ make          â† C compiler                    â”‚
â”‚   libpq-dev âœ… FIXED    â† PostgreSQL dev headers        â”‚
â”‚   python3-dev âœ… FIXED  â† Python dev headers            â”‚
â”‚                                                         â”‚
â”‚ Installs:                                               â”‚
â”‚ â”œâ”€ gcc (GNU C Compiler)                                 â”‚
â”‚ â”œâ”€ g++ (GNU C++ Compiler)                               â”‚
â”‚ â”œâ”€ make (Build tool)                                    â”‚
â”‚ â”œâ”€ libpq-dev (PostgreSQL client headers)                â”‚
â”‚ â”‚  â””â”€ Includes: libpq.h, pg_config, etc                â”‚
â”‚ â””â”€ python3-dev (Python headers: Python.h, etc)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ COPY requirements.txt .                                 â”‚
â”‚ RUN pip install --upgrade pip                           â”‚
â”‚ RUN pip install --prefix=/install -r requirements.txt  â”‚
â”‚                                                         â”‚
â”‚ Compilation Process:                                    â”‚
â”‚ â”œâ”€ asyncpg                                              â”‚
â”‚ â”‚  â”œâ”€ Searches for pre-compiled wheel                  â”‚
â”‚ â”‚  â”œâ”€ If not found â†’ compiles from source              â”‚
â”‚ â”‚  â”œâ”€ Finds libpq-dev headers âœ… NOW SUCCESS           â”‚
â”‚ â”‚  â””â”€ Builds .so library (PostgreSQL bindings)         â”‚
â”‚ â”‚                                                      â”‚
â”‚ â”œâ”€ pydantic                                             â”‚
â”‚ â”‚  â”œâ”€ Fast C implementation                             â”‚
â”‚ â”‚  â”œâ”€ Finds python3-dev headers âœ… NOW SUCCESS          â”‚
â”‚ â”‚  â””â”€ Builds .so for validation                        â”‚
â”‚ â”‚                                                      â”‚
â”‚ â””â”€ uvloop                                               â”‚
â”‚    â”œâ”€ High-performance event loop                       â”‚
â”‚    â”œâ”€ Finds gcc + make âœ…                               â”‚
â”‚    â””â”€ Builds libuv integration                          â”‚
â”‚                                                         â”‚
â”‚ Size after pip install: ~310 MB                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–¼
STAGE 1 FINAL: 450 MB (python + compilers + dev headers + wheels)
   â†“ (DISCARDED after copying installed packages)


STAGE 2: RUNTIME (EjecuciÃ³n - Final: 185 MB)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FROM python:3.12-slim                                  â”‚
â”‚ â”œâ”€ Size: 140 MB                                         â”‚
â”‚ â”œâ”€ Clean slate (no compilers!)                          â”‚
â”‚ â””â”€ Will COPY precompiled wheels from builder            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RUN apt-get install -y                                  â”‚
â”‚   curl           â† For health checks                    â”‚
â”‚   ca-certificates â† For HTTPS                           â”‚
â”‚   libpq5 âœ… FIXED â† PostgreSQL client library            â”‚
â”‚                                                         â”‚
â”‚ Note: NO gcc, NO libpq-dev (not needed for runtime)     â”‚
â”‚       Size: only 10 MB added                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ COPY --from=builder /install /usr/local                â”‚
â”‚   â”œâ”€ asycpg .so â† Precompiled PostgreSQL bindings      â”‚
â”‚   â”œâ”€ pydantic .so â† Precompiled validators              â”‚
â”‚   â”œâ”€ uvloop .so â† Precompiled event loop                â”‚
â”‚   â”œâ”€ fastapi, sqlalchemy, uvicorn (pure Python)        â”‚
â”‚   â””â”€ All 21 packages from requirements.txt              â”‚
â”‚                                                         â”‚
â”‚ Size: 35 MB (already compiled!)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ COPY alembic.ini ./                                     â”‚
â”‚ COPY alembic ./alembic                                  â”‚
â”‚ COPY config ./config                                    â”‚
â”‚ COPY src ./src                                          â”‚
â”‚ COPY dashboard ./dashboard                              â”‚
â”‚ COPY templates ./templates                              â”‚
â”‚                                                         â”‚
â”‚ Size: ~2 MB (application code + assets)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–¼
STAGE 2 FINAL: 185 MB (140 + 10 + 35 MB)

âœ… MULTI-STAGE OPTIMIZATION:
   Reduced: 450 MB (full builder) â†’ 185 MB (runtime only)
   Saving: 265 MB = 59% reduction
```

---

## 4. DEPENDENCY COMPILATION REQUIREMENTS

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    C EXTENSION PACKAGES & COMPILATION REQUIREMENTS       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

PACKAGE: asyncpg (PostgreSQL async driver)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ What it does:                                            â”‚
â”‚   Connects Python to PostgreSQL asynchronously           â”‚
â”‚                                                          â”‚
â”‚ Compilation Requirements:                                â”‚
â”‚   âœ… gcc (C compiler)                                    â”‚
â”‚   âœ… libpq-dev (PostgreSQL headers)                      â”‚
â”‚   â””â”€ Includes: libpq.h, pg_config utility               â”‚
â”‚                                                          â”‚
â”‚ Build Process:                                           â”‚
â”‚   1. pip searches for wheel for python-3.12-linux-x64   â”‚
â”‚   2. If not found â†’ downloads source tarball             â”‚
â”‚   3. $ gcc -I/usr/include/postgresql ...                â”‚
â”‚   4. Compiles â†’ asyncpg.cpython-312-x86_64-linux-gnu.so â”‚
â”‚   5. Installs .so into site-packages                     â”‚
â”‚                                                          â”‚
â”‚ If libpq-dev missing:                                    â”‚
â”‚   âœ— ERROR: pg_config: command not found                 â”‚
â”‚   âœ— ERROR: Could not build wheels for asyncpg           â”‚
â”‚   â””â”€ Build FAILS immediately                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

PACKAGE: pydantic (Data validation)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ What it does:                                            â”‚
â”‚   Fast data validation using Pydantic v2 C core         â”‚
â”‚                                                          â”‚
â”‚ Compilation Requirements:                                â”‚
â”‚   âœ… gcc (C compiler)                                    â”‚
â”‚   âœ… python3-dev (Python development headers)            â”‚
â”‚   â””â”€ Includes: Python.h, pythonrun.h                    â”‚
â”‚                                                          â”‚
â”‚ If python3-dev missing:                                 â”‚
â”‚   âœ— ERROR: fatal error: Python.h: No such file          â”‚
â”‚   âœ— ERROR: Could not build wheels for pydantic          â”‚
â”‚   â””â”€ Build FAILS during C extension compilation         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

PACKAGE: uvloop (Event loop replacement)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ What it does:                                            â”‚
â”‚   Drop-in replacement for asyncio (uses libuv)          â”‚
â”‚                                                          â”‚
â”‚ Compilation Requirements:                                â”‚
â”‚   âœ… gcc/g++ (C/C++ compiler)                            â”‚
â”‚   âœ… make (build tool)                                   â”‚
â”‚   â””â”€ Uses: libuv library (async I/O)                    â”‚
â”‚                                                          â”‚
â”‚ If gcc/make missing:                                    â”‚
â”‚   âœ— ERROR: make: command not found                      â”‚
â”‚   âœ— ERROR: Failed to build uvloop                       â”‚
â”‚   â””â”€ Build FAILS                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

SUMMARY: BUILD REQUIREMENTS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Compiler Toolchain      â”‚ For asyncpg, pydantic, uvloop â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ gcc/g++                 â”‚ C/C++ compiler (REQUIRED)    â”‚
â”‚ make                    â”‚ Build tool (REQUIRED)        â”‚
â”‚ libpq-dev               â”‚ PostgreSQL headers (FIXED âœ…) â”‚
â”‚ python3-dev             â”‚ Python headers (FIXED âœ…)    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ BEFORE fix (d0044d1)    â”‚ âœ— FAIL - Missing libpq-dev  â”‚
â”‚ AFTER fix (68dbe26)     â”‚ âœ… SUCCESS - All present     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. RELEASE PHASE: ALEMBIC MIGRATIONS

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          RELEASE_COMMAND EXECUTION FLOW                 â”‚
â”‚             (Before App Startup)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

fly.toml Configuration:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [deploy]                                                â”‚
â”‚   release_command = "alembic upgrade head"              â”‚
â”‚   strategy = "rolling"                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Execution Timeline:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Release Machine Created                              â”‚
â”‚    â”œâ”€ Temporary machine (exists only for this command) â”‚
â”‚    â”œâ”€ Same region: mia (Miami)                         â”‚
â”‚    â””â”€ Image pulled from registry                       â”‚
â”‚                                                         â”‚
â”‚ 2. Secrets Injected                                     â”‚
â”‚    â”œâ”€ DATABASE_URL = "postgresql+asyncpg://..."        â”‚
â”‚    â”œâ”€ REDIS_URL = "redis://..."                        â”‚
â”‚    â”œâ”€ SECRET_KEY = "1534c535..."                       â”‚
â”‚    â””â”€ (all 9+ secrets available)                       â”‚
â”‚                                                         â”‚
â”‚ 3. Release Command Starts                              â”‚
â”‚    â”œâ”€ CMD overridden: alembic upgrade head             â”‚
â”‚    â”œâ”€ Timeout: 30 seconds                              â”‚
â”‚    â””â”€ stderr/stdout captured â†’ logs                    â”‚
â”‚                                                         â”‚
â”‚ 4. Alembic Execution                                    â”‚
â”‚    â”‚                                                    â”‚
â”‚    â”œâ”€ $ alembic upgrade head                           â”‚
â”‚    â”‚   â””â”€ Log: "Alembic env.py executing..."           â”‚
â”‚    â”‚                                                    â”‚
â”‚    â”œâ”€ Read config: alembic.ini                         â”‚
â”‚    â”‚   â””â”€ sqlalchemy.url = "***" (from DATABASE_URL)  â”‚
â”‚    â”‚                                                    â”‚
â”‚    â”œâ”€ Load metadata: src.api.models.Base.metadata      â”‚
â”‚    â”‚   â”œâ”€ Import: Usuario, Efectivo, Tarea tables      â”‚
â”‚    â”‚   â””â”€ Log: "4 models detected"                     â”‚
â”‚    â”‚                                                    â”‚
â”‚    â”œâ”€ Connect to PostgreSQL                            â”‚
â”‚    â”‚   â”œâ”€ Connection string: DATABASE_URL              â”‚
â”‚    â”‚   â”œâ”€ asyncpg dialect                              â”‚
â”‚    â”‚   â””â”€ Log: "Connected to database"                 â”‚
â”‚    â”‚                                                    â”‚
â”‚    â”œâ”€ Check alembic_version table                      â”‚
â”‚    â”‚   â”œâ”€ Query: SELECT version_num FROM alembic_version
â”‚    â”‚   â”œâ”€ If table missing: CREATE TABLE               â”‚
â”‚    â”‚   â””â”€ Log: "alembic_version table present"         â”‚
â”‚    â”‚                                                    â”‚
â”‚    â”œâ”€ Compare current vs. target                       â”‚
â”‚    â”‚   â”œâ”€ Current: version 3 (last migration)          â”‚
â”‚    â”‚   â”œâ”€ Target: version 3 (head)                     â”‚
â”‚    â”‚   â””â”€ Result: "No migrations to apply" (normal)    â”‚
â”‚    â”‚                                                    â”‚
â”‚    â””â”€ Log: "head is now at abc123def"                  â”‚
â”‚                                                         â”‚
â”‚ 5. Release Command Exits                               â”‚
â”‚    â”œâ”€ Exit code: 0 (success)                           â”‚
â”‚    â”œâ”€ Logs available in flyctl logs                    â”‚
â”‚    â””â”€ Release machine destroyed                        â”‚
â”‚                                                         â”‚
â”‚ 6. Decisions                                            â”‚
â”‚    â”œâ”€ If exit=0 (success)                              â”‚
â”‚    â”‚  â””â”€ Proceed: Create production machine            â”‚
â”‚    â”‚                                                    â”‚
â”‚    â””â”€ If exit!=0 (failure)                             â”‚
â”‚       â”œâ”€ ABORT deployment                              â”‚
â”‚       â”œâ”€ Keep previous version active                  â”‚
â”‚       â”œâ”€ Release machine destroyed                     â”‚
â”‚       â””â”€ Logs: "release command failed"                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

POTENTIAL FAILURES:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Failure 1: DATABASE_URL Not Set                         â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ Error: sqlalchemy.exc.ArgumentError: Could not parse   â”‚
â”‚        connection string                               â”‚
â”‚ Fix: flyctl secrets set DATABASE_URL="..." --app ...   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Failure 2: PostgreSQL Not Accessible                   â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ Error: asyncpg.TooManyConnectionsError                 â”‚
â”‚        Could not connect to server                     â”‚
â”‚ Fix: flyctl postgres create --name db --region mia     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Failure 3: Timeout (>30s)                              â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ Error: Release command timeout                         â”‚
â”‚ Fix: Increase grace_period in fly.toml                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. RUNTIME PHASE: APPLICATION STARTUP

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          UVICORN STARTUP & LIFESPAN EVENTS              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Container Startup:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ $ CMD: uvicorn src.api.main:app \                       â”‚
â”‚        --host 0.0.0.0 \                                â”‚
â”‚        --port 8080 \                                   â”‚
â”‚        --workers 1 \                                   â”‚
â”‚        --loop uvloop                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [0] IMPORT PHASE (2-3 seconds)                          â”‚
â”‚ â”œâ”€ uvicorn loads src.api.main                           â”‚
â”‚ â”œâ”€ FastAPI module instantiation                         â”‚
â”‚ â”œâ”€ Import all routers                                   â”‚
â”‚ â”œâ”€ Load database models                                 â”‚
â”‚ â””â”€ Log: "Uvicorn server process started [pid]"          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [1] LIFESPAN STARTUP EVENT (4-5 seconds)               â”‚
â”‚                                                         â”‚
â”‚ @asynccontextmanager                                   â”‚
â”‚ async def lifespan(app: FastAPI):                       â”‚
â”‚     # STARTUP (before yielding)                         â”‚
â”‚                                                         â”‚
â”‚     â”œâ”€ get_settings()                                   â”‚
â”‚     â”‚  â””â”€ Read environment variables                    â”‚
â”‚     â”‚     â”œâ”€ SECRET_KEY=...                             â”‚
â”‚     â”‚     â”œâ”€ JWT_SECRET_KEY=...                         â”‚
â”‚     â”‚     â”œâ”€ DATABASE_URL=...                           â”‚
â”‚     â”‚     â””â”€ REDIS_URL=...                              â”‚
â”‚     â”‚                                                   â”‚
â”‚     â”œâ”€ _settings.assemble_db_url()                      â”‚
â”‚     â”‚  â””â”€ Transform postgresql:// to postgresql+asyncpg://
â”‚     â”‚                                                   â”‚
â”‚     â”œâ”€ init_db(db_url)  [TIME: 2s]                      â”‚
â”‚     â”‚  â”œâ”€ Create async_engine                           â”‚
â”‚     â”‚  â”œâ”€ Create connection pool                        â”‚
â”‚     â”‚  â”‚  â”œâ”€ pool_size = 10                             â”‚
â”‚     â”‚  â”‚  â”œâ”€ max_overflow = 20                          â”‚
â”‚     â”‚  â”‚  â”œâ”€ pool_timeout = 30s                         â”‚
â”‚     â”‚  â”‚  â””â”€ pool_recycle = 3600s                       â”‚
â”‚     â”‚  â”œâ”€ Test connection to PostgreSQL                 â”‚
â”‚     â”‚  â”œâ”€ Verify database exists                        â”‚
â”‚     â”‚  â””â”€ Log: "ConexiÃ³n a la BD establecida"           â”‚
â”‚     â”‚                                                   â”‚
â”‚     â”œâ”€ await websocket_event_emitter.start()  [TIME: 0.5s]
â”‚     â”‚  â”œâ”€ Initialize WebSocket manager                 â”‚
â”‚     â”‚  â”œâ”€ Start event bus                               â”‚
â”‚     â”‚  â””â”€ Prepare for WS connections                    â”‚
â”‚     â”‚                                                   â”‚
â”‚     â”œâ”€ initialize_websocket_integrator()  [TIME: 0.5s]  â”‚
â”‚     â”‚  â”œâ”€ Link models to WebSocket events               â”‚
â”‚     â”‚  â””â”€ Setup model â†’ WS broadcast                    â”‚
â”‚     â”‚                                                   â”‚
â”‚     â”œâ”€ initialize_metrics() [TIME: 0.1s]                â”‚
â”‚     â”‚  â”œâ”€ Setup Prometheus metrics                      â”‚
â”‚     â”‚  â”œâ”€ Create /metrics endpoint                      â”‚
â”‚     â”‚  â””â”€ Start collecting stats                        â”‚
â”‚     â”‚                                                   â”‚
â”‚     â””â”€ yield  â† SERVER NOW ACCEPTS REQUESTS             â”‚
â”‚                                                         â”‚
â”‚     # SHUTDOWN (called on SIGINT/SIGTERM)              â”‚
â”‚     â””â”€ cleanup handlers (see below)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [2] READY TO SERVE (Log messages)                       â”‚
â”‚                                                         â”‚
â”‚ [info] INFO: Uvicorn running on http://0.0.0.0:8080   â”‚
â”‚ [info] INFO: Application startup complete              â”‚
â”‚                                                         â”‚
â”‚ Now accepting HTTP requests on:                        â”‚
â”‚ â”œâ”€ http://0.0.0.0:8080 (internal)                      â”‚
â”‚ â”œâ”€ https://grupo-gad.fly.dev (external via LB)         â”‚
â”‚ â””â”€ WebSocket: wss://grupo-gad.fly.dev/ws/connect      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [3] HEALTH CHECKS PASS (Grace period complete)         â”‚
â”‚                                                         â”‚
â”‚ GET /health                                             â”‚
â”‚ Response: 200 OK                                        â”‚
â”‚ {                                                       â”‚
â”‚   "status": "ok",                                      â”‚
â”‚   "timestamp": "2025-10-19T12:34:56Z",                 â”‚
â”‚   "uptime": 5.234                                      â”‚
â”‚ }                                                       â”‚
â”‚                                                         â”‚
â”‚ Result: MACHINE IS HEALTHY âœ…                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


GRACEFUL SHUTDOWN (on SIGINT/SIGTERM):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Signal Handler: SIGINT (Ctrl-C or Fly.io shutdown)      â”‚
â”‚ â””â”€ Uvicorn stops accepting NEW connections             â”‚
â”‚                                                         â”‚
â”‚ Graceful Shutdown Sequence (max 30s):                  â”‚
â”‚ â”œâ”€ [1] Wait for in-flight requests to complete         â”‚
â”‚ â”œâ”€ [2] lifespan finally block executes                 â”‚
â”‚ â”‚       â”œâ”€ await websocket_manager.shutdown()          â”‚
â”‚ â”‚       â”œâ”€ await database.dispose()                    â”‚
â”‚ â”‚       â””â”€ close connection pools                      â”‚
â”‚ â”œâ”€ [3] All connections closed                          â”‚
â”‚ â””â”€ [4] Process exits (code 0)                          â”‚
â”‚                                                         â”‚
â”‚ If >30s: SIGKILL sent (forced shutdown)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. HEALTH CHECK FLOW

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              HEALTH CHECK MECHANISM                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Configuration (fly.toml):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [[services.http_checks]]                                â”‚
â”‚   interval = "15s"        # Check every 15 seconds      â”‚
â”‚   timeout = "10s"         # Wait max 10s for response   â”‚
â”‚   grace_period = "30s"    # Wait 30s before first check â”‚
â”‚   restart_limit = 3       # Restart after 3 failures    â”‚
â”‚   method = "GET"                                        â”‚
â”‚   path = "/health"                                      â”‚
â”‚   protocol = "http"                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Timeline:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Time    Event                    Status    Action       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0:00    Container starts         -         -            â”‚
â”‚         Application initializing                         â”‚
â”‚                                                         â”‚
â”‚ 0:30    Grace period ends        READY     Check #1     â”‚
â”‚         First health check sent                          â”‚
â”‚                                                         â”‚
â”‚         GET /health                                    â”‚
â”‚         Timeout: 10s                                    â”‚
â”‚         Response: 200 OK âœ…                             â”‚
â”‚         Result: PASS (1/3)                              â”‚
â”‚                                                         â”‚
â”‚ 0:45    Health check #2          OK        PASS (2/3)   â”‚
â”‚         GET /health â†’ 200 OK                            â”‚
â”‚                                                         â”‚
â”‚ 1:00    Health check #3          OK        PASS (3/3)   â”‚
â”‚         GET /health â†’ 200 OK                            â”‚
â”‚                                                         â”‚
â”‚ 1:05    âœ… MACHINE HEALTHY                              â”‚
â”‚         All checks passed                               â”‚
â”‚         LB starts routing traffic                       â”‚
â”‚                                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              IF HEALTH CHECK FAILS                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚ 0:45    Check #1: FAIL ðŸ˜ž                               â”‚
â”‚         GET /health â†’ 500 ERROR                         â”‚
â”‚         Reason: Uvicorn not ready yet                   â”‚
â”‚         Action: retry in 15s                            â”‚
â”‚                                                         â”‚
â”‚ 1:00    Check #2: FAIL ðŸ˜ž                               â”‚
â”‚         GET /health â†’ 503 SERVICE UNAVAILABLE           â”‚
â”‚         Reason: DB connection pool error                â”‚
â”‚         Action: retry in 15s                            â”‚
â”‚                                                         â”‚
â”‚ 1:15    Check #3: FAIL ðŸ˜ž                               â”‚
â”‚         GET /health â†’ Connection Refused                â”‚
â”‚         Reason: Process crashed                         â”‚
â”‚         Action: restart_limit reached â†’ KILL + RESTART  â”‚
â”‚                                                         â”‚
â”‚ 1:20    Container restarted                             â”‚
â”‚         [info] Starting application again               â”‚
â”‚         New check counter: 0/3                          â”‚
â”‚         Grace period: 30s                               â”‚
â”‚                                                         â”‚
â”‚ 1:50    Check #1 (restarted): PASS âœ…                   â”‚
â”‚         Cycle repeats...                                â”‚
â”‚                                                         â”‚
â”‚ OR (continuous failures):                               â”‚
â”‚                                                         â”‚
â”‚ After 10+ restarts â†’ Machine killed                     â”‚
â”‚ Error: "Machine crashed: health check failures"         â”‚
â”‚ Action: Manual investigation required                   â”‚
â”‚         flyctl ssh console --app grupo-gad              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Health Check Endpoint:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ @app.get("/health")                                    â”‚
â”‚ async def health_check() -> dict:                      â”‚
â”‚     return {                                            â”‚
â”‚         "status": "ok",                                 â”‚
â”‚         "timestamp": datetime.utcnow().isoformat(),     â”‚
â”‚         "uptime": time.time() - app.state.start_time   â”‚
â”‚     }                                                   â”‚
â”‚                                                         â”‚
â”‚ Response: 200 OK (always, as long as running)          â”‚
â”‚                                                         â”‚
â”‚ Fly.io interprets:                                      â”‚
â”‚ â”œâ”€ 2xx (200-299) â†’ HEALTHY âœ…                           â”‚
â”‚ â”œâ”€ 3xx, 4xx, 5xx â†’ UNHEALTHY âŒ                         â”‚
â”‚ â””â”€ Timeout â†’ UNHEALTHY âŒ                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 8. SECRETS INJECTION & TIMING

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         SECRETS LIFECYCLE IN FLY.IO                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Stored in Fly.io:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ flyctl secrets set \                                    â”‚
â”‚   SECRET_KEY="..." \                                    â”‚
â”‚   JWT_SECRET_KEY="..." \                                â”‚
â”‚   DATABASE_URL="..." \                                  â”‚
â”‚   --app grupo-gad                                       â”‚
â”‚                                                         â”‚
â”‚ Stored in encrypted vault:                              â”‚
â”‚ grupo-gad/secrets/SECRET_KEY                            â”‚
â”‚ grupo-gad/secrets/JWT_SECRET_KEY                        â”‚
â”‚ grupo-gad/secrets/DATABASE_URL                          â”‚
â”‚ ...                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

When Machine Starts:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Fly.io provisioning orchestrator                     â”‚
â”‚    â”œâ”€ Select region: mia                                â”‚
â”‚    â”œâ”€ Allocate resources: 1 CPU, 512MB RAM              â”‚
â”‚    â””â”€ Launch VM                                         â”‚
â”‚                                                         â”‚
â”‚ 2. Secrets injection (BEFORE app starts)               â”‚
â”‚    â”œâ”€ Fetch encrypted secrets from vault                â”‚
â”‚    â”œâ”€ Decrypt (using VM's ephemeral key)                â”‚
â”‚    â”œâ”€ Write to process environment (not disk!)          â”‚
â”‚    â”‚  â”œâ”€ $SECRET_KEY                                    â”‚
â”‚    â”‚  â”œâ”€ $JWT_SECRET_KEY                                â”‚
â”‚    â”‚  â”œâ”€ $DATABASE_URL                                  â”‚
â”‚    â”‚  â””â”€ (ALL 9+ secrets available)                     â”‚
â”‚    â””â”€ secrets are NEVER written to disk                 â”‚
â”‚                                                         â”‚
â”‚ 3. Container image mounted                              â”‚
â”‚    â”œâ”€ Pull from registry.fly.io                         â”‚
â”‚    â”œâ”€ Mount as root filesystem                          â”‚
â”‚    â””â”€ (Dockerfile CMD ready to execute)                â”‚
â”‚                                                         â”‚
â”‚ 4. CMD execution with secrets                           â”‚
â”‚    â””â”€ $ ENV_VARS_INJECTED CMD...                        â”‚
â”‚       â”œâ”€ release_command (if deploy mode)               â”‚
â”‚       â”‚  $ alembic upgrade head                         â”‚
â”‚       â”‚  (can read $DATABASE_URL, $REDIS_URL)           â”‚
â”‚       â”‚                                                 â”‚
â”‚       â””â”€ Normal CMD (uvicorn)                           â”‚
â”‚          $ uvicorn src.api.main:app                    â”‚
â”‚          (settings.py reads $SECRET_KEY)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Application Level:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ config/settings.py                                      â”‚
â”‚                                                         â”‚
â”‚ class Settings(BaseSettings):                           â”‚
â”‚     SECRET_KEY: str  # Read from $SECRET_KEY env var   â”‚
â”‚     JWT_SECRET_KEY: str                                 â”‚
â”‚     DATABASE_URL: Optional[str]                         â”‚
â”‚     REDIS_URL: Optional[str]                            â”‚
â”‚     ...                                                 â”‚
â”‚                                                         â”‚
â”‚ # Pydantic automatic .env loading:                      â”‚
â”‚ # Priority:                                             â”‚
â”‚ # 1. os.environ (injected by Fly.io) âœ… USED            â”‚
â”‚ # 2. .env.production file                               â”‚
â”‚ # 3. .env file                                          â”‚
â”‚                                                         â”‚
â”‚ settings = Settings()                                   â”‚
â”‚ # Now can access: settings.SECRET_KEY, etc              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Validation:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ At startup, src/api/main.py checks:                     â”‚
â”‚                                                         â”‚
â”‚ _settings = get_settings()  # Loads from env            â”‚
â”‚                                                         â”‚
â”‚ if not db_url:                                          â”‚
â”‚     raise RuntimeError("DATABASE_URL no configurada")   â”‚
â”‚ # If missing â†’ ðŸ’¥ Startup failure                       â”‚
â”‚                                                         â”‚
â”‚ if len(settings.SECRET_KEY) < 32:                       â”‚
â”‚     raise ValueError("SECRET_KEY too short")            â”‚
â”‚ # If invalid â†’ ðŸ’¥ Startup failure                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**DocumentaciÃ³n completa de diagramas finalizada.**  
*Ver DEEP_DEPLOYMENT_ANALYSIS.md para anÃ¡lisis en texto profundo.*

