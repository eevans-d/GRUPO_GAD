# üó∫Ô∏è Gu√≠a Espec√≠fica: PostgreSQL + PostGIS en Cloud SQL

**Configuraciones y mejores pr√°cticas para datos geoespaciales en GCP**

---

## üìã Tabla de Contenidos

1. [Creaci√≥n de Instancia Optimizada](#1-creaci√≥n-de-instancia-optimizada)
2. [Habilitar PostGIS](#2-habilitar-postgis)
3. [Migraci√≥n de Datos Geoespaciales](#3-migraci√≥n-de-datos-geoespaciales)
4. [Optimizaci√≥n de Queries Espaciales](#4-optimizaci√≥n-de-queries-espaciales)
5. [Backups y Restauraci√≥n](#5-backups-y-restauraci√≥n)
6. [Troubleshooting Com√∫n](#6-troubleshooting-com√∫n)

---

## 1. Creaci√≥n de Instancia Optimizada

### Comando de Creaci√≥n Completo

```bash
gcloud sql instances create grupo-gad-db \
  --database-version=POSTGRES_15 \
  --tier=db-custom-2-8192 \
  --region=us-central1 \
  --network=grupo-gad-vpc \
  --no-assign-ip \
  --availability-type=REGIONAL \
  --storage-type=SSD \
  --storage-size=50GB \
  --storage-auto-increase \
  --storage-auto-increase-limit=500GB \
  --backup-start-time=03:00 \
  --enable-bin-log \
  --retained-backups-count=30 \
  --retained-transaction-log-days=7 \
  --enable-point-in-time-recovery \
  --maintenance-window-day=SUN \
  --maintenance-window-hour=4 \
  --maintenance-release-channel=production \
  --database-flags=\
max_connections=200,\
shared_buffers=2048MB,\
effective_cache_size=6144MB,\
maintenance_work_mem=512MB,\
checkpoint_completion_target=0.9,\
wal_buffers=16MB,\
default_statistics_target=100,\
random_page_cost=1.1,\
effective_io_concurrency=200,\
work_mem=10485kB,\
min_wal_size=1GB,\
max_wal_size=4GB,\
max_worker_processes=4,\
max_parallel_workers_per_gather=2,\
max_parallel_workers=4,\
max_parallel_maintenance_workers=2
```

### Configuraciones Espec√≠ficas para PostGIS

```bash
# Flags adicionales para optimizar operaciones geoespaciales
gcloud sql instances patch grupo-gad-db \
  --database-flags=\
shared_buffers=2048MB,\
work_mem=50MB,\
maintenance_work_mem=512MB,\
random_page_cost=1.1,\
effective_io_concurrency=200,\
max_worker_processes=8,\
max_parallel_workers_per_gather=4
```

---

## 2. Habilitar PostGIS

### M√©todo 1: Via psql

```bash
# Conectar a la instancia
gcloud sql connect grupo-gad-db --user=postgres --quiet

# Dentro de psql
\c gad_db

-- Habilitar extensiones
CREATE EXTENSION IF NOT EXISTS postgis;
CREATE EXTENSION IF NOT EXISTS postgis_topology;
CREATE EXTENSION IF NOT EXISTS postgis_raster;
CREATE EXTENSION IF NOT EXISTS postgis_sfcgal;
CREATE EXTENSION IF NOT EXISTS fuzzystrmatch;
CREATE EXTENSION IF NOT EXISTS postgis_tiger_geocoder;
CREATE EXTENSION IF NOT EXISTS address_standardizer;
CREATE EXTENSION IF NOT EXISTS pgcrypto;
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- Verificar versiones
SELECT PostGIS_version();
SELECT PostGIS_full_version();

-- Verificar extensiones instaladas
\dx

-- Debe mostrar algo como:
--  postgis        | 3.3.2     | public     | PostGIS geometry and geography spatial types
```

### M√©todo 2: Via Script SQL Automatizado

Crear archivo `scripts/cloud/init_postgis_cloud.sql`:

```sql
-- ================================================================
-- Script de Inicializaci√≥n PostGIS para Cloud SQL
-- Proyecto: GRUPO_GAD
-- ================================================================

-- Conectar a la base de datos principal
\c gad_db

-- Habilitar extensiones esenciales
CREATE EXTENSION IF NOT EXISTS postgis;
CREATE EXTENSION IF NOT EXISTS postgis_topology;
CREATE EXTENSION IF NOT EXISTS pgcrypto;
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- Crear esquema para datos espaciales (opcional)
CREATE SCHEMA IF NOT EXISTS spatial;

-- Verificar instalaci√≥n
DO $$
BEGIN
    RAISE NOTICE 'PostGIS version: %', PostGIS_version();
    RAISE NOTICE 'PostGIS full version: %', PostGIS_full_version();
END
$$;

-- Crear funci√≥n helper para validar geometr√≠as
CREATE OR REPLACE FUNCTION validate_geometry(geom geometry)
RETURNS boolean AS $$
BEGIN
    RETURN ST_IsValid(geom);
EXCEPTION
    WHEN OTHERS THEN
        RETURN false;
END;
$$ LANGUAGE plpgsql IMMUTABLE;

-- Crear √≠ndices espaciales para tablas existentes (ejemplo)
-- Descomentar y ajustar seg√∫n tus tablas

-- CREATE INDEX IF NOT EXISTS idx_ubicaciones_geom 
--   ON ubicaciones USING GIST (geom);

-- CREATE INDEX IF NOT EXISTS idx_zonas_geom 
--   ON zonas USING GIST (geometria);

-- Grants de permisos para usuario de aplicaci√≥n
GRANT USAGE ON SCHEMA public TO gad_user;
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO gad_user;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO gad_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO gad_user;

-- Verificaci√≥n final
SELECT 
    e.extname AS "Extension",
    e.extversion AS "Version",
    n.nspname AS "Schema"
FROM pg_extension e
JOIN pg_namespace n ON e.extnamespace = n.oid
WHERE e.extname LIKE 'postgis%' OR e.extname IN ('pgcrypto', 'uuid-ossp')
ORDER BY e.extname;
```

Ejecutar:

```bash
# Via Cloud SQL Proxy
export PGPASSWORD=$(gcloud secrets versions access latest --secret="POSTGRES_PASSWORD")
psql "host=127.0.0.1 port=5432 dbname=gad_db user=postgres" \
  -f scripts/cloud/init_postgis_cloud.sql
```

---

## 3. Migraci√≥n de Datos Geoespaciales

### Preparar Datos Locales para Exportaci√≥n

```bash
# 1. Dump completo con formato custom (m√°s eficiente)
pg_dump -Fc \
  -h localhost \
  -U gad_user \
  -d gad_db \
  -f grupo_gad_backup.dump

# 2. Dump solo schema (para verificaci√≥n)
pg_dump -h localhost -U gad_user -d gad_db --schema-only \
  > schema_only.sql

# 3. Dump solo datos geoespaciales (si tienes tablas espec√≠ficas)
pg_dump -h localhost -U gad_user -d gad_db \
  --table=ubicaciones \
  --table=zonas_operativas \
  > geodata_only.sql
```

### Subir a Cloud Storage

```bash
# Crear bucket temporal para migraci√≥n
gsutil mb -l us-central1 gs://grupo-gad-migration-temp/

# Subir dump
gsutil cp grupo_gad_backup.dump gs://grupo-gad-migration-temp/

# Configurar permisos para Cloud SQL
gsutil iam ch \
  serviceAccount:$(gcloud sql instances describe grupo-gad-db \
    --format="value(serviceAccountEmailAddress)"):objectViewer \
  gs://grupo-gad-migration-temp
```

### Importar a Cloud SQL

```bash
# M√©todo 1: Import completo
gcloud sql import sql grupo-gad-db \
  gs://grupo-gad-migration-temp/grupo_gad_backup.dump \
  --database=gad_db

# M√©todo 2: Import v√≠a psql (para m√°s control)
./cloud_sql_proxy -instances=grupo-gad-prod:us-central1:grupo-gad-db=tcp:5432 &

pg_restore -h localhost -p 5432 -U gad_user -d gad_db \
  --verbose \
  --no-owner \
  --no-acl \
  grupo_gad_backup.dump
```

### Verificar Integridad de Datos Geoespaciales

```sql
-- Conectar a Cloud SQL
-- gcloud sql connect grupo-gad-db --user=gad_user --database=gad_db

-- 1. Verificar conteo de registros
SELECT 
    schemaname,
    tablename,
    n_live_tup as row_count
FROM pg_stat_user_tables
ORDER BY n_live_tup DESC;

-- 2. Verificar geometr√≠as v√°lidas
SELECT 
    'ubicaciones' as tabla,
    COUNT(*) as total,
    COUNT(*) FILTER (WHERE ST_IsValid(geom)) as validas,
    COUNT(*) FILTER (WHERE NOT ST_IsValid(geom)) as invalidas
FROM ubicaciones;

-- 3. Verificar SRIDs (sistemas de referencia espacial)
SELECT DISTINCT 
    ST_SRID(geom) as srid,
    COUNT(*) as count
FROM ubicaciones
GROUP BY ST_SRID(geom);

-- 4. Verificar extensi√≥n espacial de datos
SELECT 
    ST_AsText(ST_Extent(geom)) as bounding_box,
    ST_AsText(ST_Centroid(ST_Extent(geom))) as centroid
FROM ubicaciones;

-- 5. Verificar √≠ndices espaciales
SELECT
    schemaname,
    tablename,
    indexname,
    indexdef
FROM pg_indexes
WHERE indexdef LIKE '%GIST%'
ORDER BY tablename;
```

---

## 4. Optimizaci√≥n de Queries Espaciales

### Crear √çndices Espaciales Optimizados

```sql
-- √çndices GIST b√°sicos (m√°s r√°pidos para queries espaciales generales)
CREATE INDEX idx_ubicaciones_geom ON ubicaciones USING GIST(geom);

-- √çndices con opciones de compresi√≥n
CREATE INDEX idx_zonas_geom ON zonas_operativas 
USING GIST(geometria) WITH (FILLFACTOR=90);

-- √çndices parciales (solo para geometr√≠as v√°lidas)
CREATE INDEX idx_ubicaciones_validas ON ubicaciones USING GIST(geom)
WHERE ST_IsValid(geom);

-- √çndices compuestos (espacial + atributo)
CREATE INDEX idx_ubicaciones_geom_tipo ON ubicaciones 
USING GIST(geom, tipo_ubicacion);

-- Estad√≠sticas de geometr√≠as (mejora el query planner)
ANALYZE ubicaciones;
```

### Queries Optimizadas con PostGIS

```sql
-- B√∫squeda por distancia (con √≠ndice espacial)
EXPLAIN ANALYZE
SELECT id, nombre, ST_Distance(geom, ST_SetSRID(ST_MakePoint(-99.1332, 19.4326), 4326)) as distancia
FROM ubicaciones
WHERE ST_DWithin(
    geom,
    ST_SetSRID(ST_MakePoint(-99.1332, 19.4326), 4326),
    0.1  -- ~11 km en grados decimales
)
ORDER BY distancia
LIMIT 10;

-- B√∫squeda por contenci√≥n (punto dentro de pol√≠gono)
SELECT z.id, z.nombre
FROM zonas_operativas z
WHERE ST_Contains(z.geometria, ST_SetSRID(ST_MakePoint(-99.1332, 19.4326), 4326));

-- Intersecci√≥n de geometr√≠as
SELECT 
    u.id as ubicacion_id,
    z.id as zona_id,
    ST_Area(ST_Intersection(u.geom, z.geometria)) as area_interseccion
FROM ubicaciones u
JOIN zonas_operativas z ON ST_Intersects(u.geom, z.geometria)
WHERE ST_Area(ST_Intersection(u.geom, z.geometria)) > 0.001;

-- Buffer alrededor de punto (crear zona de influencia)
SELECT 
    ST_AsGeoJSON(ST_Buffer(geom::geography, 1000)::geometry) as buffer_1km
FROM ubicaciones
WHERE id = 123;
```

### Configuraciones de Query Performance

```sql
-- Aumentar work_mem para queries complejas (sesi√≥n espec√≠fica)
SET work_mem = '256MB';

-- Deshabilitar nested loops para queries espaciales grandes
SET enable_nestloop = OFF;

-- Ver plan de ejecuci√≥n detallado
EXPLAIN (ANALYZE, BUFFERS, VERBOSE)
SELECT ...;
```

---

## 5. Backups y Restauraci√≥n

### Backups Autom√°ticos

```bash
# Ya configurados en la creaci√≥n de instancia, verificar:
gcloud sql instances describe grupo-gad-db \
  --format="value(settings.backupConfiguration)"

# Crear backup manual antes de cambios importantes
gcloud sql backups create \
  --instance=grupo-gad-db \
  --description="Pre-migration spatial data backup $(date +%Y-%m-%d)"

# Listar backups disponibles
gcloud sql backups list --instance=grupo-gad-db
```

### Export Manual de Datos Espaciales

```bash
# Export completo de base de datos
gcloud sql export sql grupo-gad-db \
  gs://grupo-gad-backups/manual/full_backup_$(date +%Y%m%d_%H%M%S).sql.gz \
  --database=gad_db

# Export solo de tablas espaciales espec√≠ficas
gcloud sql export sql grupo-gad-db \
  gs://grupo-gad-backups/spatial/geodata_$(date +%Y%m%d).sql.gz \
  --database=gad_db \
  --table=ubicaciones,zonas_operativas
```

### Restauraci√≥n Completa

```bash
# Opci√≥n 1: Restaurar desde backup autom√°tico
gcloud sql backups restore BACKUP_ID \
  --backup-instance=grupo-gad-db \
  --backup-id=BACKUP_ID

# Opci√≥n 2: Restaurar desde export SQL
gcloud sql import sql grupo-gad-db \
  gs://grupo-gad-backups/manual/full_backup_20251010.sql.gz \
  --database=gad_db

# Opci√≥n 3: Point-in-time recovery (PITR)
gcloud sql instances restore-backup grupo-gad-db \
  --backup-id=BACKUP_ID \
  --backup-instance=grupo-gad-db

# Verificar restauraci√≥n
gcloud sql connect grupo-gad-db --user=gad_user --database=gad_db
```

### Script de Backup Automatizado

Crear `scripts/cloud/backup_postgis_cloud.sh`:

```bash
#!/usr/bin/env bash
# Backup automatizado de PostGIS en Cloud SQL

set -euo pipefail

PROJECT_ID="grupo-gad-prod"
INSTANCE_NAME="grupo-gad-db"
DATABASE="gad_db"
BUCKET="gs://grupo-gad-backups"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

echo "üóÑÔ∏è  Iniciando backup de PostGIS..."

# Crear backup autom√°tico
gcloud sql backups create \
  --instance=${INSTANCE_NAME} \
  --description="Automated backup ${TIMESTAMP}"

# Export a Cloud Storage
gcloud sql export sql ${INSTANCE_NAME} \
  ${BUCKET}/automated/backup_${TIMESTAMP}.sql.gz \
  --database=${DATABASE}

# Limpiar backups antiguos (> 30 d√≠as)
gsutil -m rm ${BUCKET}/automated/backup_$(date -d '30 days ago' +%Y%m%d)*.sql.gz 2>/dev/null || true

echo "‚úÖ Backup completado: ${BUCKET}/automated/backup_${TIMESTAMP}.sql.gz"
```

---

## 6. Troubleshooting Com√∫n

### Problema: Extensi√≥n PostGIS no disponible

```bash
# Verificar versi√≥n de PostgreSQL
gcloud sql instances describe grupo-gad-db \
  --format="value(databaseVersion)"

# PostGIS requiere PostgreSQL 12+
# Si es versi√≥n antigua, crear nueva instancia y migrar
```

### Problema: Queries espaciales lentas

```sql
-- 1. Verificar √≠ndices espaciales
SELECT 
    schemaname,
    tablename,
    indexname,
    pg_size_pretty(pg_relation_size(indexname::regclass)) as index_size
FROM pg_indexes
WHERE indexdef LIKE '%GIST%';

-- 2. Re-crear √≠ndice si est√° fragmentado
REINDEX INDEX idx_ubicaciones_geom;

-- 3. Actualizar estad√≠sticas
ANALYZE ubicaciones;

-- 4. Vacuum para liberar espacio
VACUUM ANALYZE ubicaciones;
```

### Problema: Geometr√≠as inv√°lidas despu√©s de migraci√≥n

```sql
-- Detectar geometr√≠as inv√°lidas
SELECT id, ST_IsValidReason(geom) as reason
FROM ubicaciones
WHERE NOT ST_IsValid(geom);

-- Reparar geometr√≠as inv√°lidas
UPDATE ubicaciones
SET geom = ST_MakeValid(geom)
WHERE NOT ST_IsValid(geom);

-- Verificar reparaci√≥n
SELECT COUNT(*) as geometrias_invalidas
FROM ubicaciones
WHERE NOT ST_IsValid(geom);
```

### Problema: SRID inconsistente

```sql
-- Detectar SRIDs diferentes
SELECT DISTINCT ST_SRID(geom) as srid, COUNT(*) as count
FROM ubicaciones
GROUP BY ST_SRID(geom);

-- Estandarizar a SRID 4326 (WGS 84 - est√°ndar mundial)
UPDATE ubicaciones
SET geom = ST_Transform(ST_SetSRID(geom, SRID_ACTUAL), 4326)
WHERE ST_SRID(geom) != 4326;
```

### Problema: Out of Memory en queries complejas

```bash
# Aumentar work_mem en la instancia
gcloud sql instances patch grupo-gad-db \
  --database-flags=work_mem=100MB

# O temporalmente en sesi√≥n
# SET work_mem = '256MB';
```

---

## üìä Monitoreo de Rendimiento PostGIS

### Queries de Diagn√≥stico

```sql
-- Queries lentas (> 1 segundo)
SELECT 
    query,
    calls,
    total_time,
    mean_time,
    max_time
FROM pg_stat_statements
WHERE mean_time > 1000
ORDER BY mean_time DESC
LIMIT 10;

-- Tama√±o de tablas espaciales
SELECT 
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as total_size,
    pg_size_pretty(pg_relation_size(schemaname||'.'||tablename)) as table_size,
    pg_size_pretty(pg_indexes_size(schemaname||'.'||tablename)) as indexes_size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;

-- Uso de cache en √≠ndices espaciales
SELECT 
    schemaname,
    tablename,
    indexname,
    idx_scan as index_scans,
    idx_tup_read as tuples_read,
    idx_tup_fetch as tuples_fetched
FROM pg_stat_user_indexes
WHERE indexname LIKE '%geom%'
ORDER BY idx_scan DESC;
```

---

## üìö Referencias

- [PostGIS Documentation](https://postgis.net/documentation/)
- [Cloud SQL for PostgreSQL](https://cloud.google.com/sql/docs/postgres)
- [PostGIS Performance Tips](https://postgis.net/workshops/postgis-intro/performance.html)
- [Spatial Indexes in PostGIS](https://postgis.net/docs/using_postgis_dbmanagement.html#spatial_index)

---

*Actualizado: 10 de Octubre, 2025*  
*Versi√≥n: 1.0.0*
